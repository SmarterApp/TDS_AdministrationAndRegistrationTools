package org.opentestsystem.delivery.testreg.rest.diagnostic.client;

import org.apache.commons.codec.binary.Base64;
import org.opentestsystem.delivery.testreg.rest.diagnostic.model.RabbitMQStatus;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.web.client.RestClientException;
import org.springframework.web.client.RestTemplate;

public class RabbitMQHealthCheck {
    final private String host;
    final private RestTemplate restTemplate;
    final private HttpEntity<String> request;
    final static private String url = "http://{host}:15672/api/healthchecks/node";

    public RabbitMQHealthCheck(final RestTemplate restTemplate, String host, final String username, final String password) {
        this.host = host;

        String credentials = String.format("%s:%s", username, password);
        byte[] credentialsBytes = credentials.getBytes();
        byte[] base64Bytes = Base64.encodeBase64(credentialsBytes);
        String base64 = new String(base64Bytes);

        HttpHeaders headers = new HttpHeaders();
        headers.add("Authorization", "Basic " + base64);
        request = new HttpEntity<>(headers);

        this.restTemplate = restTemplate;
    }

    public String getHost() {
        return host;
    }

    public RabbitMQStatus getStatus() throws RestClientException {
        ResponseEntity<RabbitMQStatus> response = restTemplate.exchange(url, HttpMethod.GET, request, RabbitMQStatus.class, host);
        return response.getBody();
    }
}
