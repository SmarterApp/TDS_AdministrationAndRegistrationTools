package org.opentestsystem.delivery.testreg.rest.diagnostic;

import com.mongodb.MongoClient;
import de.flapdoodle.embed.mongo.distribution.Version;
import de.flapdoodle.embed.mongo.tests.MongodForTestsFactory;
import org.junit.After;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.delivery.testreg.rest.diagnostic.client.MongoDBHealthCheck;
import org.springframework.data.mongodb.core.MongoTemplate;

public class MongoDBTest {
    MongodForTestsFactory factory;
    MongoClient mongo;
    MongoTemplate mongoTemplate;

    @Before
    public void setup() throws Exception {
        factory = MongodForTestsFactory.with(Version.Main.V2_6);
        mongo = factory.newMongo();
        mongoTemplate = new MongoTemplate(mongo, "test-art");
    }

    @After
    public void teardown() throws Exception {
        if (factory != null) {
            factory.shutdown();
        }
    }

    @Test
    public void testServerStatus() throws Exception {
        MongoDBHealthCheck mongoDBHealthCheck = new MongoDBHealthCheck(mongoTemplate);
        mongoDBHealthCheck.checkStatus();
    }

    @Test
    public void testReadOperation() throws Exception {
        MongoDBHealthCheck mongoDBHealthCheck = new MongoDBHealthCheck(mongoTemplate);
        long time = mongoDBHealthCheck.readsLatency();

        Assert.assertTrue(time > 0L);
    }

    @Test
    public void testWriteOperation() throws Exception {
        MongoDBHealthCheck mongoDBHealthCheck = new MongoDBHealthCheck(mongoTemplate);
        long time = mongoDBHealthCheck.writesLatency();

        Assert.assertTrue(time > 0L);
    }
}
